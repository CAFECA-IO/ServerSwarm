services:
  nginx:
    image: nginx:1.26.2
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/templates:/etc/nginx/templates
    env_file:
      - ./nginx/.env.nginx
    depends_on:
      - isunfa
      - faith
      - aich
    deploy:
      resources:
        limits:
          memory: 256M

  isunfa:
    image: node:20
    volumes:
      - ./isunfa:/isunfa
    command: >
      sh -c "chmod +x /isunfa/isunfa-start.sh && /isunfa/isunfa-start.sh"
    env_file:
      - ./isunfa/.env.isunfa
    environment:
      - PORT=${ISUNFA_PORT}
    expose:
      - "${ISUNFA_PORT}"
    depends_on:
      aich:
        condition: service_healthy
      postgres:
        condition: service_started
    deploy:
      resources:
        limits:
          memory: 4G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${ISUNFA_PORT}"]
      interval: 30s
      timeout: 20s
      retries: 3
      start_period: 4m

  faith:
    image: node:20
    volumes:
      - ./faith:/faith
    command: >
      sh -c "chmod +x /faith/faith-start.sh && /faith/faith-start.sh"
    env_file:
      - ./faith/.env.faith
    environment:
      - PORT=${FAITH_PORT}
    expose:
      - "${FAITH_PORT}"
    depends_on:
      aich:
        condition: service_healthy
      ollama:
        condition: service_started
      qdrant:
        condition: service_started
    deploy:
      resources:
        limits:
          memory: 1G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${FAITH_PORT}"]
      interval: 30s
      timeout: 20s
      retries: 3
      start_period: 2m

  aich:
    image: node:20
    volumes:
      - ./aich:/aich
    command: >
      sh -c "chmod +x /aich/aich-start.sh && /aich/aich-start.sh"
    env_file:
      - ./aich/.env.aich
    environment:
      - PORT=${AICH_PORT}
    expose:
      - "${AICH_PORT}"
    depends_on:
      - ollama
      - qdrant
    deploy:
      resources:
        limits:
          memory: 2G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${AICH_PORT}"]
      interval: 30s
      timeout: 20s
      retries: 3
      start_period: 2m

  ollama:
    image: ollama/ollama:0.3.6
    volumes:
      - ./ollama:/root/.ollama
    restart: always
    # Info (20240822 - Jacky): Uncomment the following lines to enable GPU support.

    deploy:
      resources:
        limits:
          memory: 17G
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

    expose:
      - "${OLLAMA_PORT}"
    env_file:
      - ./ollama/.env.ollama
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "chmod +x /root/.ollama/ollama-start.sh && /root/.ollama/ollama-start.sh"

  qdrant:
    image: qdrant/qdrant:v1.11.0
    restart: always
    expose:
      - "${QDRANT_PORT}"
    configs:
      - source: qdrant_config
        target: /qdrant/config/production.yaml
    volumes:
      - ./qdrant/qdrant_data:/qdrant/storage
    deploy:
      resources:
        limits:
          memory: 1G

  postgres:
    image: postgres:16
    ports:
      - "${POSTGRES_PORT}:${POSTGRES_PORT}"
    restart: always
    volumes:
      - ./postgres/data:/var/lib/postgresql/data
    env_file:
      - ./postgres/.env.postgres
    command: -c listen_addresses='*'
    expose:
      - "${POSTGRES_PORT}"
    deploy:
      resources:
        limits:
          memory: 1G

  ofelia:
    image: mcuadros/ofelia:latest
    container_name: ofelia
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./ofelia/config.ini:/etc/ofelia/config.ini
    environment:
      - TZ=Asia/Taipei
    command: >
      daemon --config=/etc/ofelia/config.ini
    depends_on:
      aich:
        condition: service_healthy
      isunfa:
        condition: service_healthy
      faith:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 1G

configs:
  qdrant_config:
    content: |
      log_level: INFO
